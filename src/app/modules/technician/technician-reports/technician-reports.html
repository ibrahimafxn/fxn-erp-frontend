<section class="technician-reports">
  <header class="page-header">
    <div>
      <h1>Rapport quotidien</h1>
      <p class="subtitle">Saisir le nombre d'interventions et un commentaire de fin de journée.</p>
    </div>
  </header>

  <section class="card form-card">
    <form class="report-form" [formGroup]="form" (ngSubmit)="submit()">
      <label>
        Date
        <input type="date" formControlName="date" />
      </label>

      <div class="full prestations" formGroupName="prestations">
        <div class="prestations-title">Prestations</div>
        <div class="prestations-list">
          @for (item of prestationOptions; track item.key) {
            <label class="prestation-item">
              <input type="number" min="0" [formControlName]="item.key" />
              <span class="prestation-pill" [ngClass]="item.className">{{ item.label }}</span>
            </label>
          }
        </div>
      </div>

      <label class="full">
        Commentaire
        <textarea rows="3" formControlName="comment" placeholder="Ex: 12 interventions, 2 pannes, zone nord."></textarea>
      </label>

      <div class="actions">
        <button class="btn-primary" type="submit" [disabled]="loading() || form.invalid || isDefaultForm()">Enregistrer</button>
      </div>
    </form>
  </section>

  <section class="card list-card">
    <div class="list-header">
      <h2>Historique</h2>
      <div class="meta">Page {{ page() }} / {{ pageCount() }}</div>
    </div>

    <form class="history-filters" [formGroup]="filterForm" (ngSubmit)="applyFilters()">
      <label>
        Année
        <input type="number" min="2000" max="2100" placeholder="2026" formControlName="year" />
      </label>
      <label>
        Période (du)
        <input type="date" formControlName="fromDate" />
      </label>
      <label>
        Période (au)
        <input type="date" formControlName="toDate" />
      </label>
      <div class="actions">
        <button class="btn-outline" type="submit">Filtrer</button>
        <button class="btn-outline" type="button" (click)="clearFilters()">Réinitialiser</button>
      </div>
    </form>

    @if (loading()) {
      <div class="state loading">Chargement…</div>
    } @else if (error()) {
      <div class="state error">Erreur : {{ error() }}</div>
    } @else if (items().length === 0) {
      <div class="state empty">Aucun rapport disponible.</div>
    } @else {
      <div class="table">
        <table>
          <thead>
          <tr>
            <th>Date</th>
            <th>Prestations</th>
            <th>Montant</th>
            <th>Commentaire</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
            @for (report of items(); track report._id) {
              <tr>
                <td data-label="Date">{{ report.reportDate | date:'shortDate' }}</td>
                <td class="prestations-cell" data-label="Prestations">
                  @if (prestationsSummary(report).length) {
                    <div class="prestations-summary">
                      @for (item of prestationsSummary(report); track item.label) {
                        <div class="prestations-pill" [ngClass]="item.className" [ngStyle]="prestationStyle(item.key)">
                          <span class="qty">{{ item.value }}</span>
                          <span>{{ item.label }}</span>
                        </div>
                      }
                    </div>
                  } @else {
                    —
                  }
                </td>
                <td data-label="Montant">{{ formatAmount(report.amount) }}</td>
                <td class="note" data-label="Commentaire" [class.is-empty]="!report.comment">
                  @if (report.comment) { {{ report.comment }} }
                </td>
                <td class="actions" data-label="Actions">
                  @if (isToday(report)) {
                    <button class="btn-outline primary-outline" type="button" (click)="editToday(report)"><i class="bi bi-pencil"></i> Modifier</button>
                  }
                  <button class="btn-outline delete" type="button" (click)="openDeleteModal(report)"><i class="fa-solid fa-trash"></i> Supprimer</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <footer class="pager pager-fixed">
        <div class="pager-left">
          <div class="page-size">
            <button type="button" [class.active]="limit() === 10" (click)="setLimitValue(10)">10</button>
            <button type="button" [class.active]="limit() === 20" (click)="setLimitValue(20)">20</button>
            <button type="button" [class.active]="limit() === 50" (click)="setLimitValue(50)">50</button>
            <button type="button" [class.active]="limit() === 100" (click)="setLimitValue(100)">100</button>
          </div>
          <span class="pager-label">Éléments par page</span>
        </div>
        <div class="pager-right">
          <span class="pager-range">{{ pageRange(page(), limit(), total()) }}</span>
          <div class="pager-nav">
            <button class="btn-outline" type="button" (click)="prevPage()" [disabled]="!canPrev()"><i class="bi bi-chevron-left"></i></button>
            <button class="btn-outline" type="button" (click)="nextPage()" [disabled]="!canNext()"><i class="bi bi-chevron-right"></i></button>
          </div>
        </div>
      </footer>
    }
  </section>
</section>

<app-confirm-delete-modal
  [open]="deleteModalOpen()"
  entityLabel="rapport"
  [entityName]="pendingDelete()?.reportDate || ''"
  [confirming]="!!deletingId()"
  (cancel)="closeDeleteModal()"
  (confirm)="confirmDelete()"
></app-confirm-delete-modal>
