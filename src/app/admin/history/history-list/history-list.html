<section class="movement-history">
  <header class="page-header">
    <div>
      <h1>Journal des mouvements</h1>
      <p class="subtitle">Traçabilité des entrées, sorties, transferts, attributions et reprises.</p>
    </div>

    <div class="header-actions">
      <button class="btn-outline" type="button" (click)="refresh(true)"><i class="bi bi-arrow-clockwise"></i> Recharger</button>
      <button class="btn-outline" type="button" (click)="exportCsv()"><i class="bi bi-filetype-csv"></i> Exporter CSV</button>
      <button class="btn-outline" type="button" (click)="exportPdf()"><i class="bi bi-filetype-pdf"></i> Exporter PDF</button>
    </div>
  </header>

  <section class="toolbar card">
    <form class="search" [formGroup]="filterForm" (ngSubmit)="search()">
      <label>
        Ressource
        <select formControlName="resourceType">
          <option value="">Toutes ressources</option>
          <option value="MATERIAL">Matériels</option>
          <option value="CONSUMABLE">Consommables</option>
          <option value="VEHICLE">Véhicules</option>
        </select>
      </label>

      <label>
        Action
        <select formControlName="action">
          <option value="">Toutes actions</option>
          <option value="IN">Entrée</option>
          <option value="OUT">Sortie</option>
          <option value="TRANSFER">Transfert</option>
          <option value="ASSIGN">Attribution</option>
          <option value="RELEASE">Reprise</option>
          <option value="ADJUST">Ajustement</option>
          <option value="CREATE">Création</option>
          <option value="UPDATE">Modification</option>
          <option value="DELETE">Suppression</option>
        </select>
      </label>

      <label>
        Statut
        <select formControlName="status">
          <option value="">Tous statuts</option>
          <option value="COMMITTED">Validé</option>
          <option value="CANCELED">Annulé</option>
        </select>
      </label>

      <label>
        ID ressource
        <input type="text" formControlName="resourceId" placeholder="ID ressource" />
      </label>

      <label>
        Origine
        <select formControlName="fromType">
          <option value="">Origine</option>
          <option value="DEPOT">Dépôt</option>
          <option value="USER">Utilisateur</option>
          <option value="SUPPLIER">Fournisseur</option>
          <option value="EXTERNAL">Externe</option>
        </select>
      </label>

      @if (filterForm.controls.fromType.value === 'USER') {
        <label>
          Utilisateur origine
          <select formControlName="fromId" [disabled]="usersLoading()">
            <option value="">{{ usersLoading() ? 'Chargement…' : 'Tous utilisateurs' }}</option>
            @for (u of users(); track u._id) {
              <option [value]="u._id">{{ userLabel(u) }}</option>
            }
          </select>
        </label>
      } @else if (filterForm.controls.fromType.value === 'DEPOT') {
        <label>
          Dépôt origine
          <select formControlName="fromId" [disabled]="depotsLoading()">
            <option value="">{{ depotsLoading() ? 'Chargement…' : 'Tous dépôts' }}</option>
            @for (d of depots(); track d._id) {
              <option [value]="d._id">{{ depotOptionLabel(d) }}</option>
            }
          </select>
        </label>
      } @else {
        <label>
          ID origine
          <input type="text" formControlName="fromId" placeholder="ID origine" />
        </label>
      }

      <label>
        Destination
        <select formControlName="toType">
          <option value="">Destination</option>
          <option value="DEPOT">Dépôt</option>
          <option value="USER">Utilisateur</option>
          <option value="SUPPLIER">Fournisseur</option>
          <option value="EXTERNAL">Externe</option>
        </select>
      </label>

      @if (filterForm.controls.toType.value === 'USER') {
        <label>
          Utilisateur destination
          <select formControlName="toId" [disabled]="usersLoading()">
            <option value="">{{ usersLoading() ? 'Chargement…' : 'Tous utilisateurs' }}</option>
            @for (u of users(); track u._id) {
              <option [value]="u._id">{{ userLabel(u) }}</option>
            }
          </select>
        </label>
      } @else if (filterForm.controls.toType.value === 'DEPOT') {
        <label>
          Dépôt destination
          <select formControlName="toId" [disabled]="depotsLoading()">
            <option value="">{{ depotsLoading() ? 'Chargement…' : 'Tous dépôts' }}</option>
            @for (d of depots(); track d._id) {
              <option [value]="d._id">{{ depotOptionLabel(d) }}</option>
            }
          </select>
        </label>
      } @else {
        <label>
          ID destination
          <input type="text" formControlName="toId" placeholder="ID destination" />
        </label>
      }

      <div class="actions">
        <button class="btn-outline" type="submit"><i class="bi bi-search"></i> Rechercher</button>
        <button class="btn-outline" type="button" (click)="clearSearch()"><i class="bi bi-x"></i> Effacer</button>
      </div>
    </form>

    <div class="meta">
      <span class="pill">Total : {{ total() }}</span>
      <span class="pill">Page : {{ page() }} / {{ pageCount() }}</span>

      <label class="limit">
        <span>Par page</span>
        <select [value]="limit()" (change)="onLimitChange($event)">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </label>
    </div>
  </section>

  @if (loading()) {
    <div class="state loading card">Chargement…</div>
  } @else if (error()) {
    <div class="state error card"><strong>Erreur :</strong> {{ errorMessage() }}</div>
  } @else if (items().length === 0) {
    <div class="state empty card">Aucun mouvement trouvé.</div>
  } @else {
    <div class="table card">
      <table>
        <thead>
        <tr>
          <th>Date</th>
          <th>Ressource</th>
          <th>Action</th>
          <th>Origine</th>
          <th>Destination</th>
          <th>Quantité</th>
          <th>Auteur</th>
          <th>Statut</th>
          <th>Action</th>
        </tr>
        </thead>

        <tbody>
          @for (m of items(); track m._id) {
            <tr>
              <td data-label="Date">{{ createdAtText(m) }}</td>
              <td class="mono" data-label="Ressource">{{ resourceLabel(m) }}</td>
              <td data-label="Action">
                <span
                  class="badge"
                  [class.assign]="m.action === 'ASSIGN'"
                  [class.release]="m.action === 'RELEASE'"
                  [class.in]="m.action === 'IN'"
                  [class.out]="m.action === 'OUT'"
                  [class.transfer]="m.action === 'TRANSFER'"
                >
                  {{ actionLabel(m.action) }}
                </span>
              </td>
              <td class="mono" data-label="Origine">{{ endpointLabel(m.from.type, m.from.id, $any(m).fromLabel) }}</td>
              <td class="mono" data-label="Destination">{{ endpointLabel(m.to.type, m.to.id, $any(m).toLabel) }}</td>
              <td data-label="Quantité">{{ m.quantity }} {{ m.unit }}</td>
              <td data-label="Auteur">{{ authorLabel(m) }}</td>
              <td data-label="Statut">
                @if (m.status === 'CANCELED') {
                  <span class="pill danger">{{ statusLabel(m.status) }}</span>
                } @else {
                  <span class="pill ok">{{ statusLabel(m.status) }}</span>
                }
              </td>
              <td class="actions-cell" data-label="Action">
                <div class="row-actions">
                  <button
                    class="btn-outline"
                    type="button"
                    (click)="openCancelModal(m)"
                    [disabled]="!canCancel(m) || cancelLoading()[m._id]"><i class="bi bi-x"></i> Annuler</button>
                  @if (rowError(m)) {
                    <div class="state error">{{ rowError(m) }}</div>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <footer class="pager">
      <button class="btn-outline" type="button" (click)="prevPage()" [disabled]="!canPrev()"><i class="bi bi-chevron-left"></i> ← Précédent</button>
      <button class="btn-outline" type="button" (click)="nextPage()" [disabled]="!canNext()"><i class="bi bi-chevron-right"></i> Suivant →</button>
    </footer>
  }
</section>

<app-confirm-cancel-modal
  [open]="cancelModalOpen()"
  entityLabel="le mouvement"
  [entityName]="cancelTarget() ? resourceLabel(cancelTarget()!) : ''"
  [entityId]="cancelTarget()?._id ?? null"
  [confirming]="cancelTarget() ? cancelLoading()[cancelTarget()!._id] : false"
  (cancel)="closeCancelModal()"
  (confirm)="confirmCancel($event)"
></app-confirm-cancel-modal>
