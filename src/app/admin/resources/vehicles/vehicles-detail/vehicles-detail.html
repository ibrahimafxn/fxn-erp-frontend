<!-- admin/resources/vehicles/vehicle-detail/vehicle-detail.html -->
<section class="vehicle-detail">
  <!-- HEADER -->
  <header class="page-header card">
    <div class="header-left">
      <div class="title-row">
        <div class="title">{{ title() }}</div>
        <span class="pill">Véhicule</span>
        <span class="status-badge" [class]="badge().css">{{ badge().text }}</span>
      </div>

      <div class="subtitle">
        Vue synthèse : infos clés, dépôt actuel, statut et actions rapides (assigner / libérer).
      </div>
    </div>

    <div class="header-actions">
      <button class="btn-outline" type="button" (click)="back()">Retour</button>
      <button class="btn-primary" type="button" (click)="edit()" [disabled]="!hasVehicle()">Modifier</button>
      <button class="btn-outline" type="button" (click)="load()">Recharger</button>
    </div>
  </header>

  <!-- STATES -->
  @if (loading()) {
    <div class="state loading card">Chargement du véhicule…</div>
  } @else if (error()) {
    <div class="state error card"><strong>Erreur :</strong> {{ error() }}</div>
  } @else if (!hasVehicle()) {
    <div class="state empty card">Aucune donnée véhicule.</div>
  } @else {
    <section class="grid">
      <!-- IDENTITÉ -->
      <article class="card">
        <div class="identity">
          <div class="avatar">
            {{ (vehicle()?.plateNumber || 'VH').slice(0, 2).toUpperCase() }}
          </div>

          <div class="identity-text">
            <div class="name">{{ title() }}</div>
            <div class="meta">
              <span class="chip">{{ vehicle()?.plateNumber || '—' }}</span>
              <span class="chip">{{ vehicle()?.state || '—' }}</span>
              @if (vehicle()?.year) { <span class="chip">{{ vehicle()?.year }}</span> }
            </div>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <label>Marque</label>
            <div>{{ vehicle()?.brand || '—' }}</div>
          </div>

          <div class="info-item">
            <label>Modèle</label>
            <div>{{ vehicle()?.model || '—' }}</div>
          </div>

          <div class="info-item">
            <label>Plaque</label>
            <div class="mono">{{ vehicle()?.plateNumber || '—' }}</div>
          </div>

          <div class="info-item">
            <label>VIN</label>
            <div class="mono">{{ vehicle()?.vin || '—' }}</div>
          </div>

          <div class="info-item">
            <label>Dépôt actuel</label>
            <div>
              @if (vehicle()?.idDepot) {
                {{ depotNameById(vehicle()?.idDepot || null) }}
              } @else {
                —
              }
            </div>
          </div>

          <div class="info-item">
            <label>Assigné à</label>
            <div class="mono">{{ vehicle()?.assignedTo || '—' }}</div>
          </div>

          <div class="info-item">
            <label>Créé le</label>
            <div>
              @if (createdAtValue()) { {{ createdAtValue() | date:'fullDate' }} } @else { — }
            </div>
          </div>

          <div class="info-item">
            <label>ID</label>
            <div class="mono">{{ id }}</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card-actions">
          <button class="btn-outline" type="button" (click)="openAssign()">Assigner</button>
          <button class="btn-outline" type="button" (click)="openRelease()">Libérer</button>
        </div>

        @if (assignMode() !== 'idle') {
          <div class="panel">
            <div class="panel-title">
              @if (assignMode() === 'assign') { Assignation }
              @else { Reprise / Libération }
            </div>

            @if (actionError()) {
              <div class="state error">{{ actionError() }}</div>
            }

            @if (assignMode() === 'assign') {
              @if (techLoading()) {
                <div class="state loading">Chargement des techniciens…</div>
              } @else {
                <label class="sub-label">Technicien</label>
                <select class="select" [value]="selectedTechId()" (change)="onTechSelect($event)">
                  <option value="">— Sélectionner —</option>
                  @for (t of technicians(); track t._id) {
                    <option [value]="t._id">
                      {{ t.firstName }} {{ t.lastName || '' }} · {{ t.email || '—' }}
                    </option>
                  }
                </select>
              }

              <div class="panel-actions">
                <button class="btn-outline btn-xs" type="button" (click)="closeActions()" [disabled]="actionSaving()">
                  Annuler
                </button>
                <button class="btn-primary btn-xs" type="button" (click)="assignToTech()" [disabled]="actionSaving()">
                  @if (actionSaving()) { Enregistrement… } @else { Assigner }
                </button>
              </div>
            } @else {
              <p class="hint">
                Libère le véhicule et le remet au dépôt actuel.
              </p>

              <div class="panel-actions">
                <button class="btn-outline btn-xs" type="button" (click)="closeActions()" [disabled]="actionSaving()">
                  Annuler
                </button>
                <button class="btn-danger btn-xs" type="button" (click)="releaseToDepot()" [disabled]="actionSaving()">
                  @if (actionSaving()) { Enregistrement… } @else { Libérer }
                </button>
              </div>
            }
          </div>
        }
      </article>

      <!-- HISTORIQUE (structure UI) -->
      <article class="card">
        <div class="card-title-row">
          <h2>Historique d’attribution</h2>
          <span class="hint">à brancher</span>
        </div>

        <div class="state empty">
          Ajoute un endpoint du style <span class="mono">/api/vehicles/:id/history</span> (assign / release),
          puis affiche ici la timeline (date, action, technicien, dépôt, auteur).
        </div>

        <div class="timeline-skeleton">
          <div class="timeline-item"></div>
          <div class="timeline-item"></div>
          <div class="timeline-item"></div>
        </div>
      </article>

      <!-- ACTIONS RAPIDES -->
      <article class="card">
        <div class="card-title-row">
          <h2>Actions rapides</h2>
        </div>

        <div class="quick-actions">
          <button class="btn-outline" type="button" (click)="openAssign()">Assigner à un technicien</button>
          <button class="btn-outline" type="button" (click)="openRelease()">Libérer au dépôt</button>
          <button class="btn-primary" type="button" (click)="edit()">Modifier la fiche</button>
        </div>

        <p class="note">
          Tip UI/UX : quand tu auras l’historique, affiche un <strong>dernier mouvement</strong>
          (ex: “Assigné à Issa · 20/12/2025”).
        </p>
      </article>
    </section>
  }
</section>
