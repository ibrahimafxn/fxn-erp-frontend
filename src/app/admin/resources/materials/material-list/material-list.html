<section class="materials-list" xmlns="http://www.w3.org/1999/html">
  <header class="page-header">
    <div>
      <h1>Matériels</h1>
      <p class="subtitle">Recherche, filtres, pagination et actions rapides.</p>
    </div>

    <div class="header-actions">
      @if (!isReadOnly()) {
        <button class="btn-outline" type="button" (click)="exportCsv()"><i class="bi bi-filetype-csv"></i> Exporter CSV</button>
        <button class="btn-outline" type="button" (click)="exportPdf()"><i class="bi bi-filetype-pdf"></i> Exporter PDF</button>
      }
      @if (!isDepotManager() && !isReadOnly()) {
        <button class="btn-primary" type="button" (click)="createNew()"><i class="bi bi-plus"></i> Nouveau</button>
      }
    </div>
  </header>

  <section class="toolbar card">
    <form class="search" [formGroup]="filterForm" (ngSubmit)="search()">
      <input type="text" formControlName="q" placeholder="Rechercher (nom, catégorie, ref…)…" />

      @if (!isDepotManager() && !isReadOnly()) {
        <select formControlName="depot">
          <option value="">Tous les dépôts</option>
          @for (d of depots(); track d._id) {
          <option [value]="d._id">{{ depotOptionLabel(d) }}</option>
          }
        </select>
      }

      <button class="btn-outline" type="submit"><i class="bi bi-search"></i> Rechercher</button>
      <button class="btn-outline" type="button" (click)="clearSearch()"><i class="bi bi-x"></i> Effacer</button>
    </form>

  </section>

  @if (loading()) {
    <div class="state loading card">Chargement…</div>
  } @else if (error()) {
    <div class="state error card"><strong>Erreur :</strong> {{ errorMessage() }}</div>
  } @else if (items().length === 0) {
    <div class="state empty card">Aucun matériel trouvé.</div>
  } @else {
    <div class="table card">
      <table>
        <thead>
        <tr>
          <th>
            <button class="sort-btn" type="button" (click)="setSort('name')">
              Matériel <span class="sort-indicator">{{ sortIndicator('name') }}</span>
            </button>
          </th>
          @if (!isReadOnly()) {
            <th>
              <button class="sort-btn" type="button" (click)="setSort('available')">
                Disponible <span class="sort-indicator">{{ sortIndicator('available') }}</span>
              </button>
            </th>
          }
          @if (!isReadOnly()) {
            <th>
              <button class="sort-btn" type="button" (click)="setSort('category')">
                Catégorie <span class="sort-indicator">{{ sortIndicator('category') }}</span>
              </button>
            </th>
          }
          <th>
            <button class="sort-btn" type="button" (click)="setSort('depot')">
              Dépôt <span class="sort-indicator">{{ sortIndicator('depot') }}</span>
            </button>
          </th>
          <th>
            <button class="sort-btn" type="button" (click)="setSort('updatedAt')">
              Mise à jour * <span class="sort-indicator">{{ sortIndicator('updatedAt') }}</span>
            </button>
          </th>
        </tr>
        </thead>

        <tbody>
          @for (m of sortedItems(); track trackById($index, m)) {
            <tr class="row" (click)="openDetail(m)">
              <td class="main" data-label="Matériel">
                <div class="name">{{ materialName(m) }}</div>
              </td>

              @if (!isReadOnly()) {
                <td data-label="Disponible"><span class="qty">{{ availableQty(m) }}</span></td>
              }
              @if (!isReadOnly()) {
                <td data-label="Catégorie">
                  <span class="tag" [class.tag-epi]="(m.category || '').toLowerCase().includes('epi')">
                    {{ m.category || '—' }}
                  </span>
                </td>
              }
              <td data-label="Dépôt">{{ depotLabel(m) }}</td>

              <td data-label="Mise à jour">
                @if (updatedAtValue(m)) { {{ updatedAtValue(m) | date:'short' }} } @else { — }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <footer class="pager pager-fixed">
      <div class="pager-left">
        <div class="page-size">
          <button type="button" [class.active]="limit() === 10" (click)="setLimitValue(10)">10</button>
          <button type="button" [class.active]="limit() === 20" (click)="setLimitValue(20)">20</button>
          <button type="button" [class.active]="limit() === 50" (click)="setLimitValue(50)">50</button>
          <button type="button" [class.active]="limit() === 100" (click)="setLimitValue(100)">100</button>
        </div>
        <span class="pager-label">Éléments par page</span>
      </div>
      <div class="pager-right">
        <span class="pager-range">{{ pageRange(page(), limit(), total()) }}</span>
        <div class="pager-nav">
          <button class="btn-outline" type="button" (click)="prevPage()" [disabled]="!canPrev()"><i class="bi bi-chevron-left"></i></button>
          <button class="btn-outline" type="button" (click)="nextPage()" [disabled]="!canNext()"><i class="bi bi-chevron-right"></i></button>
        </div>
      </div>
    </footer>
  }
  <!-- ✅ MODAL suppression -->
  <app-confirm-delete-modal
    [open]="deleteModalOpen()"
    entityLabel="le matériel"
    [entityName]="pendingDeleteName()"
    [entityId]="pendingDeleteId()"
    [confirming]="pendingDeleteId() !== null && deletingId() === pendingDeleteId()"
    (cancel)="closeDeleteModal()"
    (confirm)="confirmDelete()">
  </app-confirm-delete-modal>
</section>
