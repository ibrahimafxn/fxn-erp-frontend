<section class="user-list">

  <header class="page-header">
    <div>
      <h1>Utilisateurs</h1>
      <p class="subtitle">Gestion des comptes employés / techniciens</p>
    </div>

    <div class="header-actions">
      <button class="btn-outline" type="button" (click)="back()">Dashboard</button>
      <button class="btn-outline" type="button" (click)="load(true)">Recharger</button>
      <button class="btn-primary" type="button" (click)="create()">+ Nouvel utilisateur</button>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar card">
    <div class="field">
      <label>Recherche</label>
      <input
        type="text"
        [formControl]="q"
        placeholder="Nom, email, téléphone, username…"
      />
    </div>

    <div class="field">
      <label>Rôle</label>
      <select [formControl]="role">
        @for (r of roleOptions; track r.value) {
          <option [value]="r.value">{{ r.label }}</option>
        }
      </select>
    </div>
  </div>

  <!-- States -->
  @if (loading()) {
    <div class="state loading">Chargement…</div>
  } @else if (errorText()) {
    <div class="state error">
      Erreur : <code>{{ errorText() }}</code>
    </div>
  } @else {

    @if (rows().length === 0) {
      <div class="state empty">Aucun utilisateur trouvé.</div>
    } @else {

      <div class="table card">
        <table>
          <thead>
          <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Téléphone</th>
            <th>Rôle</th>
            <th>Créé le</th>
            <th class="col-actions">Actions</th>
          </tr>
          </thead>

          <tbody>
            @for (u of rows(); track trackById) {
              <tr class="row-click" (click)="open(u)">
                <td class="name">
                  <div class="name-main">{{ u.fullName }}</div>
                  <div class="name-sub">{{ u.id }}</div>
                </td>

                <td>{{ u.email }}</td>
                <td>{{ u.phone || '—' }}</td>

                <td>
                  <span class="role-badge role-{{ u.role.toLowerCase() }}">
                    {{ u.role }}
                  </span>
                </td>

                <td>{{ u.createdAtText }}</td>

                <td class="row-actions" (click)="$event.stopPropagation()">
                  <button type="button" class="btn-outline" (click)="edit(u)">
                    Modifier
                  </button>

                  <button
                    type="button"
                    class="btn-danger"
                    [disabled]="deletingId() === u.id"
                    (click)="delete(u)"
                  >
                    @if (deletingId() === u.id) { Suppression… } @else { Supprimer }
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pager">
        <button class="btn-outline" type="button" (click)="prev()" [disabled]="page() <= 1">
          ← Précédent
        </button>

        <div class="pager-info">
          Page {{ page() }} / {{ totalPages() }}
          @if (result(); as r) {
            <span class="muted"> · {{ r.total }} total</span>
          }
        </div>

        <button class="btn-outline" type="button" (click)="next()" [disabled]="page() >= totalPages()">
          Suivant →
        </button>
      </div>

    }
  }

</section>
