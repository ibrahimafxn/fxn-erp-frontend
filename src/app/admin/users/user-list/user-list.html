<section class="users-list">
  <header class="page-header">
    <div>
      <h1>Utilisateurs</h1>
      <p class="subtitle">Recherche, filtres, pagination et actions rapides.</p>
    </div>

    <div class="header-actions">
      <button class="btn-outline" type="button" (click)="exportCsv()"><i class="bi bi-filetype-csv"></i> Exporter CSV</button>
      <button class="btn-outline" type="button" (click)="exportPdf()"><i class="bi bi-filetype-pdf"></i> Exporter PDF</button>
      <button class="btn-primary" type="button" (click)="createNew()"><i class="bi bi-plus"></i> Nouveau</button>
    </div>
  </header>

  <section class="toolbar card">
    <form class="search" [formGroup]="filterForm" (ngSubmit)="search()" autocomplete="off">
      <!-- ✅ Anti-autofill (cause de q=ibrahima...) -->
      <input
        type="search"
        formControlName="q"
        placeholder="Rechercher (nom, email, téléphone, username)…"
        autocomplete="new-password"
        autocapitalize="off"
        spellcheck="false"
      />

      <select formControlName="role">
        <option value="">Tous les rôles</option>
        <option value="DIRIGEANT">DIRIGEANT</option>
        <option value="ADMIN">ADMIN</option>
        <option value="GESTION_DEPOT">GESTION_DEPOT</option>
        <option value="TECHNICIEN">TECHNICIEN</option>
      </select>

      <select formControlName="depot">
        <option value="">Tous les dépôts</option>
        @for (d of depots(); track d._id) {
          <option [value]="d._id">{{ depotOptionLabel(d) }}</option>
        }
      </select>

      <button class="btn-outline" type="submit"><i class="bi bi-search"></i> Rechercher</button>
      <button class="btn-outline" type="button" (click)="clearSearch()"><i class="bi bi-x"></i> Effacer</button>
    </form>

    <div class="meta">
      <span class="pill">Total : {{ total() }}</span>
      <span class="pill">Page : {{ page() }} / {{ pageCount() }}</span>

      <label class="limit">
        <span>Par page</span>
        <select [value]="limit()" (change)="onLimitChange($event)">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </label>
    </div>
  </section>

  @if (loading()) {
    <div class="state loading card">Chargement…</div>
  } @else if (error()) {
    <div class="state error card"><strong>Erreur :</strong> {{ errorMessage() }}</div>
  } @else if (items().length === 0) {
    <div class="state empty card">Aucun utilisateur trouvé.</div>
  } @else {
    <div class="table card">
      <table>
        <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>Rôle</th>
          <th>Dépôt</th>
          <th>Accès</th>
          <th>Création</th>
        </tr>
        </thead>

        <tbody>
          @for (u of items(); track trackById($index, u)) {
            <tr class="row" (click)="openDetail(u)">
              <td class="main" data-label="Utilisateur">
                <div class="user-cell">
                  <div class="avatar">
                    @if (u.photoUrl || u.avatarUrl) {
                      <img [src]="u.photoUrl || u.avatarUrl" alt="Photo de profil" />
                    } @else {
                      <span>{{ userInitials(u) }}</span>
                    }
                  </div>
                  <div class="user-info">
                    <div class="name">{{ userName(u) }}</div>
                    <div class="sub">{{ u.phone || u.email || '—' }}</div>
                  </div>
                </div>
              </td>

              <td data-label="Email">{{ u.email || '—' }}</td>

              <td data-label="Rôle">
                <span
                  class="badge role"
                  [class.role-admin]="u.role === 'ADMIN'"
                  [class.role-dirigeant]="u.role === 'DIRIGEANT'"
                  [class.role-depot]="u.role === 'GESTION_DEPOT'"
                  [class.role-tech]="u.role === 'TECHNICIEN'"
                >{{ u.role || '—' }}</span>
              </td>

              <td data-label="Dépôt">
                <span class="depot-pill" [class.empty]="!u.idDepot">{{ depotLabel(u) }}</span>
              </td>

              <td data-label="Accès">
                <span class="access-pill" [class.off]="!u.authEnabled">
                  {{ u.authEnabled ? 'Accès actif' : 'Accès désactivé' }}
                </span>
              </td>

                <td data-label="Création">
                @if (createdAtValue(u)) {
                  {{ formatDate(u.createdAt)}}
                } @else {
                  —
                }
              </td>

            </tr>
          }
        </tbody>
      </table>
    </div>

    <footer class="pager">
      <button class="btn-outline" type="button" (click)="prevPage()" [disabled]="page() <= 1"><i class="bi bi-chevron-left"></i> ← Précédent</button>

      <button class="btn-outline" type="button" (click)="nextPage()" [disabled]="page() >= pageCount()"><i class="bi bi-chevron-right"></i> Suivant →
      </button>
    </footer>
  }
  <app-confirm-delete-modal
    [open]="deleteModalOpen()"
    [entityLabel]="pendingDeleteLabel()"
    [entityName]="pendingDeleteName()"
    [entityId]="pendingDeleteId()"
    [confirming]="pendingDeleteId() !== null && deletingId() === pendingDeleteId()"
    (cancel)="closeDeleteModal()"
    (confirm)="confirmDelete()"
  />

</section>
