<section class="admin-dashboard">
  <header class="hero">
    <div class="hero-text">
      <span class="hero-badge">ERP FXN · ERT Technologie</span>
      <h1>Poste de commandement des stocks</h1>
      <p class="subtitle">
        Vue stratégique des matériels, consommables et véhicules pour piloter le terrain en temps réel.
      </p>

      @if (stats(); as s) {
        <div class="hero-kpis">
          <div class="hero-kpi">
            <span class="label">Utilisateurs</span>
            <span class="value">{{ s.totalUsers }}</span>
          </div>
          <div class="hero-kpi">
            <span class="label">Dépôts</span>
            <span class="value">{{ s.totalDepots }}</span>
          </div>
          <div class="hero-kpi">
            <span class="label">Flotte</span>
            <span class="value">{{ s.totalVehicles }}</span>
          </div>
        </div>
      }
    </div>

    <div class="hero-actions">
      <button class="btn-outline" type="button" (click)="goToHistory()">Journal des mouvements</button>
      <button class="btn-outline" type="button" (click)="goToOnboarding()">Onboarding</button>
      <button class="btn-primary" type="button" (click)="adminService.loadDashboardStats()"><i class="bi bi-arrow-clockwise"></i> Recharger les données</button>
    </div>
  </header>

  <!-- Messages de statut global -->
  <div class="status-bar">
    @if (loading()) {
      <div class="status loading">
        Chargement des données...
      </div>
    }

    <div class="status error" *ngIf="!loading() && error() as err">
      <span>Une erreur est survenue :</span>
      <code>{{ error().message || err }}</code>
    </div>
  </div>

  @if (stats(); as s) {
    <section class="alert-strip">
      <div class="alert-pill" [class.hot]="(s.totalLowStockMaterials ?? 0) > 0">
        Stock bas matériels : <strong>{{ s.totalLowStockMaterials ?? 0 }}</strong>
      </div>
      <div class="alert-pill" [class.hot]="(s.totalLowStockConsumables ?? 0) > 0">
        Stock bas consommables : <strong>{{ s.totalLowStockConsumables ?? 0 }}</strong>
      </div>
      <div class="alert-pill" [class.hot]="(s.totalVehicleAlerts ?? 0) > 0">
        Alertes véhicules : <strong>{{ s.totalVehicleAlerts ?? 0 }}</strong>
      </div>
    </section>
  }

  <section class="action-grid">
    <article class="action-card" (click)="goToNewUser()">
      <div class="action-title">Nouveau collaborateur</div>
      <div class="action-subtitle">Créer un utilisateur et activer l'accès</div>
    </article>
    <article class="action-card" (click)="goToNewDepot()">
      <div class="action-title">Nouveau dépôt</div>
      <div class="action-subtitle">Ajouter un point logistique</div>
    </article>
    <article class="action-card" (click)="goToInterventions()">
      <div class="action-title">Importer interventions</div>
      <div class="action-subtitle">Charger un CSV ERT</div>
    </article>
    <article class="action-card" (click)="goToStockAlerts()">
      <div class="action-title">Voir les alertes</div>
      <div class="action-subtitle">Stocks critiques et pannes</div>
    </article>
  </section>

  <!-- KPIs principaux -->
  <section class="kpi-grid" *ngIf="stats() as s">
    <article class="kpi-card clickable" (click)="goToUsers()">
      <div class="kpi-icon kpi-users">U</div>
      <div class="kpi-text">
        <div class="kpi-label">Utilisateurs</div>
        <div class="kpi-value">{{ s.totalUsers }}</div>
        <div class="kpi-footer">Tous rôles confondus</div>
      </div>
    </article>

    <article class="kpi-card clickable" (click)="goToDepots()">
      <div class="kpi-icon kpi-depots">D</div>
      <div class="kpi-text">
        <div class="kpi-label">Dépôts</div>
        <div class="kpi-value">{{ s.totalDepots }}</div>
        <div class="kpi-footer">Points logistiques actifs</div>
      </div>
    </article>

    <article class="kpi-card clickable" (click)="goToResources('materials')">
      <div class="kpi-icon kpi-materials">M</div>
      <div class="kpi-text">
        <div class="kpi-label">Matériels</div>
        <div class="kpi-value">{{ s.totalMaterials }}</div>
        <div class="kpi-footer">Références disponibles</div>
      </div>
    </article>

    <article class="kpi-card clickable" (click)="goToResources('consumables')">
      <div class="kpi-icon kpi-consumables">C</div>
      <div class="kpi-text">
        <div class="kpi-label">Consommables</div>
        <div class="kpi-value">{{ s.totalConsumables }}</div>
        <div class="kpi-footer">Articles suivis</div>
      </div>
    </article>

    <article class="kpi-card clickable" (click)="goToResources('vehicles')">
      <div class="kpi-icon kpi-vehicles">V</div>
      <div class="kpi-text">
        <div class="kpi-label">Véhicules</div>
        <div class="kpi-value">{{ s.totalVehicles }}</div>
        <div class="kpi-footer">Flotte opérationnelle</div>
      </div>
    </article>

    <article class="kpi-card clickable" (click)="goToStockAlerts()">
      <div class="kpi-icon kpi-alerts">!</div>
      <div class="kpi-text">
        <div class="kpi-label">Alertes</div>
        <div class="kpi-value">{{ s.totalAlerts ?? s.totalLowStock ?? 0 }}</div>
        <div class="kpi-footer">Stock + véhicules</div>
      </div>
    </article>
  </section>

  <section class="empty-state" *ngIf="!stats() && !loading() && !error()">
    <p>Aucune donnée de dashboard pour le moment.</p>
  </section>

  <!-- Derniers mouvements -->
  <section class="history-section" *ngIf="recentHistory().length">
    <div class="history-header">
      <h2>Derniers mouvements de stock</h2>
      <button class="btn-outline" type="button" (click)="goToHistory()"><i class="bi bi-eye"></i> Voir tout</button>
    </div>

    <div class="history-table-wrapper">
      <table class="history-table">
        <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Action</th>
          <th>Ressource</th>
          <th>Dépot / Utilisateur</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let h of recentHistory(); trackBy: trackHistory">
          <td>{{ h.timestamp | date: 'short' }}</td>
          <td>{{ h.resourceType || '—' }}</td>
          <td>{{ h.action || '—' }}</td>
          <td>{{ h.resourceName || h.resourceId || '—' }}</td>
          <td>
            <span *ngIf="h.depotName">{{ h.depotName }}</span>
            <span *ngIf="h.userName"> · {{ h.userName }}</span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>
  <section class="empty-state" *ngIf="!recentHistory().length && !loading()">
    <p>Aucun mouvement récent. Lance un premier mouvement pour alimenter le journal.</p>
  </section>
</section>
