<section class="receipt-page">
  <header class="page-header">
    <div>
      <h1>Réception commande</h1>
      <p class="subtitle">Ajoute les ressources au dépôt en consolidant l’existant.</p>
    </div>
  </header>

  <div class="section-tabs">
    <button class="btn-outline" type="button" [class.active]="activeSection() === 'new'" (click)="setSection('new')">
      Nouvelle réception
    </button>
    <button class="btn-outline" type="button" [class.active]="activeSection() === 'history'" (click)="setSection('history')">
      Historique des réceptions
    </button>
  </div>

  @if (activeSection() === 'new') {
    <article class="card">
      <h2 class="section-title"><span class="material-icons notranslate">inventory_2</span>Nouvelle réception</h2>
      <form class="receipt-form" [formGroup]="form" (ngSubmit)="submit()">
        <div class="form-grid">
          @if (!isDepotManager()) {
            <label>
              Dépôt
              <select formControlName="depotId" [disabled]="depotsLoading()">
                <option value="">{{ depotsLoading() ? 'Chargement…' : 'Choisir un dépôt' }}</option>
                @for (d of depots(); track d._id) {
                  <option [value]="d._id">{{ depotLabelById(d._id) }}</option>
                }
              </select>
            </label>
          }
          <label>
            Fournisseur
            <input type="text" formControlName="supplier" placeholder="Ex: SFR / Partenaire" />
          </label>
          <label>
            Référence commande
            <input type="text" formControlName="reference" placeholder="Ex: CMD-2025-09" />
          </label>
        </div>

        <label>
          Note globale
          <textarea rows="2" formControlName="note" placeholder="Commentaire global…"></textarea>
        </label>

        <div class="lines">
          <div class="lines-header">
            <h3 class="section-title"><span class="material-icons notranslate">playlist_add</span>Lignes réception</h3>
            <button class="btn-outline" type="button" (click)="addLine()"><i class="bi bi-plus"></i> Ajouter une ligne</button>
          </div>

          @for (line of lines().controls; track $index) {
            <div class="line-card" [formGroup]="lineGroup($index)">
              <div class="line-grid">
                <label>
                  Type
                  <select formControlName="resourceType">
                    <option value="CONSUMABLE">Consommable</option>
                    <option value="MATERIAL">Matériel</option>
                  </select>
                </label>
                <label>
                  Ressource
                  <select formControlName="resourceId">
                    <option value="">— Sélectionner —</option>
                    @for (opt of resourceOptions(line.get('resourceType')?.value || 'CONSUMABLE'); track opt._id) {
                      <option [value]="opt._id">{{ opt.label }}</option>
                    }
                  </select>
                </label>
                <label>
                  Quantité
                  <input type="number" min="1" formControlName="quantity" />
                </label>
              </div>
              <div class="line-actions">
                <button class="btn-outline" type="button" (click)="removeLine($index)" [disabled]="lines().length <= 1">
                  Retirer
                </button>
              </div>
            </div>
          }
        </div>

        @if (submitError()) {
          <div class="state error">{{ submitError() }}</div>
        } @else if (submitSuccess()) {
          <div class="state success">{{ submitSuccess() }}</div>
        }

        <div class="actions">
          <button class="btn-save" type="submit" [disabled]="submitting() || form.invalid"><i class="fa-solid fa-check"></i> Enregistrer la réception</button>
        </div>
      </form>
    </article>
  } @else {
    <article class="card">
      <header class="card-title-row">
        <h2 class="section-title"><span class="material-icons notranslate">history</span>Historique des réceptions</h2>
        <div class="header-actions">
          <button class="btn-outline" type="button" (click)="refreshHistory(true)"><i class="bi bi-arrow-clockwise"></i> Recharger</button>
          <button class="btn-outline" type="button" (click)="exportCsv()"><i class="bi bi-filetype-csv"></i> Exporter CSV</button>
          <button class="btn-outline" type="button" (click)="exportPdf()"><i class="bi bi-filetype-pdf"></i> Exporter PDF</button>
        </div>
      </header>

      <form class="history-filters" [formGroup]="filterForm" (ngSubmit)="searchHistory()">
        <label>
          Type
          <select formControlName="resourceType">
            <option value="">Tous</option>
            <option value="CONSUMABLE">Consommables</option>
            <option value="MATERIAL">Matériels</option>
          </select>
        </label>
        <label>
          Ressource
          <input type="text" formControlName="resourceName" placeholder="Nom ressource" />
        </label>
        @if (showDepotFilter()) {
          <label>
            Dépôt
            <select formControlName="depot" [disabled]="depotsLoading()">
              <option value="">{{ depotsLoading() ? 'Chargement…' : 'Tous dépôts' }}</option>
              @for (d of depots(); track d._id) {
                <option [value]="d._id">{{ depotLabelById(d._id) }}</option>
              }
            </select>
          </label>
        }
        <label>
          Du
          <input type="date" formControlName="fromDate" />
        </label>
        <label>
          Au
          <input type="date" formControlName="toDate" />
        </label>
        <div class="filter-actions">
          <button class="btn-outline" type="submit"><i class="bi bi-search"></i> Rechercher</button>
          <button class="btn-outline" type="button" (click)="clearHistory()"><i class="bi bi-x"></i> Effacer</button>
        </div>
      </form>


      @if (historyLoading()) {
        <div class="state loading">Chargement…</div>
      } @else if (historyError()) {
        <div class="state error">Erreur : {{ historyError()?.message || 'Erreur' }}</div>
      } @else if (historyItems().length === 0) {
        <div class="state empty">Aucune réception trouvée.</div>
      } @else {
        <div class="table">
          <table>
            <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Ressource</th>
              <th>Quantité</th>
              <th>Origine</th>
              <th>Note</th>
            </tr>
            </thead>
            <tbody>
              @for (m of historyItems(); track m._id) {
                <tr>
                  <td>{{ createdAtText(m) }}</td>
                  <td>{{ m.resourceType }}</td>
                  <td>{{ movementResourceLabel(m) }}</td>
                  <td>{{ m.quantity }} {{ m.unit }}</td>
                  <td>{{ originLabel(m) }}</td>
                  <td class="note">{{ m.note || '—' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <footer class="pager pager-fixed">
          <div class="pager-left">
            <div class="page-size">
              <button type="button" [class.active]="historyLimit() === 10" (click)="setHistoryLimitValue(10)">10</button>
              <button type="button" [class.active]="historyLimit() === 20" (click)="setHistoryLimitValue(20)">20</button>
              <button type="button" [class.active]="historyLimit() === 50" (click)="setHistoryLimitValue(50)">50</button>
              <button type="button" [class.active]="historyLimit() === 100" (click)="setHistoryLimitValue(100)">100</button>
            </div>
            <span class="pager-label">Éléments par page</span>
          </div>
          <div class="pager-right">
            <span class="pager-range">{{ pageRange(historyPage(), historyLimit(), historyTotal()) }}</span>
            <div class="pager-nav">
              <button class="btn-outline" type="button" (click)="prevHistory()" [disabled]="!canPrev()"><i class="bi bi-chevron-left"></i></button>
              <button class="btn-outline" type="button" (click)="nextHistory()" [disabled]="!canNext()"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
        </footer>
      }
    </article>
  }
</section>
